/*! hex 19-08-2013 */
var hex=function(){var a={width:null,height:null},b={left:37,up:38,right:39,down:40},c=function(a){return a.x+","+a.y},d=function(){"use strict";var a=function(a,b){return _.reduce(a,function(a,c){var d={};return _.each(c,function(c,e){d[e]=b(c,a[e])}),d})};return{add:function(){return a(arguments,function(a,b){return a+b})},dotProduct:function(){return a(arguments,function(a,b){return a*b})},negative:function(a){var b={};return _.each(a,function(a,c){b[c]=-a}),b},subtract:function(a,b){return this.add(a,this.negative(b))}}}(),e=function(a){return 0>a?-1:1},f=function(a){var b=a.x,c=a.y,d=Math.abs(b)>.001?Math.atan(c/b):Math.PI/2*-e(c);return d+=0>=b&&0>=c||0>=b&&c>0?Math.PI:0,{radius:Math.sqrt(b*b+c*c),theta:d}},g=function(a){return{x:a.radius*Math.cos(a.theta),y:a.radius*Math.sin(a.theta)}},h=function(a){return Math.PI*a/180},i=function(a,b){"use strict";b=b||{x:0,y:0};var c=[];return _.each(_.range(1+b.x-a,b.x+a),function(d){_.each(_.range(1+b.y-a,b.y+a),function(e){Math.abs(d-b.x+e-b.y)<a&&c.push({x:d,y:e})})}),c},j=function(a){"use strict";var b=jsMessage.mixinPubSub(),d=a.size,e=function(){var a={};return _.each(i(d),function(b){a[b.x+","+b.y]={}}),a}(),f=function(){b.publish("board",e)};return b.getBoard=function(){return e},b.focus=function(){var a={};return function(b){var d,g;_.isEqual(b,a)||(d=e[c(b)],g=e[c(a)],g&&(g.focus=!1),d&&(d.focus=!0),a=b,f())}}(),b},k=function(b){"use strict";var c={};return c.hexagon=function(){var a,c,d=[];return function(e){var f=e.center.x,g=e.center.y;(e.radius!==a||e.tilt!==c)&&(a=e.radius,c=e.tilt,d=_.map(_.range(0,2*Math.PI,Math.PI/3),function(b){return{x:Math.cos(b+c)*a,y:Math.sin(b+c)*a}})),b.strokeStyle=e.stroke||"rgb(150, 150, 80)",b.fillStyle=e.fill||"rgb(0, 71, 111)",b.beginPath(),b.moveTo(f+d[0].x,g+d[0].y),_.each(_.rest(d),function(a){b.lineTo(f+a.x,g+a.y)}),b.closePath(),b.fill(),b.stroke(),b.strokeText(e.coord.x+", "+e.coord.y,f,g)}}(),c.clear=function(){b.clearRect(0,0,a.width,a.height)},c},l=function(b){"use strict";var e={},h=b.draw,j=null,k=null,l={x:a.width/2,y:a.height/2},m=function(a,b){return g(d.add(f(a),{radius:0,theta:b}))},n=function(a,b,c){return d.add(m({x:1.5*a.x*j-b.x,y:2*a.y*k+a.x*k-b.y},c),l)},o=function(a){var b=Math.round(a.x/(1.5*j)),c=Math.round(-b/2+a.y/(2*k));return{x:b,y:c}},p=function(b){return b.x>=-j&&b.x<a.width+j&&b.y>=-j&&b.y<a.height+j},q=function(b){var c=Math.floor(_.max([a.width,a.height])/(1.5*j)/2+4);return i(c,o(b))};return e.pixelToCoord=function(a){j=-a.radius,k=a.radius*Math.sqrt(3)/2;var b=a.center,c=a.pixel,e=a.tilt,f=d.add(b,m(d.subtract(c,l),-e));f.x*=-1;var g=o(f);return g},e.drawHexagonalGrid=function(a){j=a.radius,k=a.radius*Math.sqrt(3)/2,_.each(q(a.center),function(b){var d=n(b,a.center,a.tilt),e=a.board[c(b)];e&&p(d)&&h.hexagon({center:d,coord:b,radius:j,tilt:a.tilt,fill:e.focus?"green":null})})},e.clear=function(){h.clear()},e},m=function(b){"use strict";var c={},i=b.model,j=b.view,k={x:1,y:0},l={x:0,y:0},m=0,n=40;return c.drawBoard=function(a){j.clear(),j.drawHexagonalGrid({board:a,center:k,tilt:m,radius:n})},c.tick=function(){var a,b,e={x:0,y:0};return function(){(0!==l.x||0!==l.y||a!==m||b!==n)&&(k=d.add(k,l),c.drawBoard(i.getBoard()),e.x=k.x,e.y=k.y,a=m,b=n)}}(),c.focus=function(a){i.focus(a)},c.rotate=function(a){m+=h(a)},c.zoom=function(a){n+=n+a>=25&&150>=n+a?a:0},c.coordAt=function(a){return j.pixelToCoord({center:k,tilt:m,radius:n,pixel:a})},c.borderScroll=function(){var b=function(a,b){return Math.abs(a)>b/6?e(a)*(Math.abs(a)-b/6)/20:0};return function(c){var e=d.add(c,{x:-a.width/2,y:-a.height/2}),h={x:b(e.x,a.width),y:b(e.y,a.height)};l=g(d.add(f(h),{radius:0,theta:-m}))}}(),c},n=function(c){"use strict";var d,e={},f=c.$canvas,g=c.$startButton,h=c.$stopButton,i=c.hex,j=function(a){var b,c,d;return a||(a=window.event),a.target?b=a.target:a.srcElement&&(b=a.srcElement),3==b.nodeType&&(b=b.parentNode),c=a.pageX-$(b).offset().left,d=a.pageY-$(b).offset().top,{x:c,y:d}};return e.start=function(){d||(d=setInterval(function(){i.tick()},16))},e.stop=function(){clearInterval(d),d=null},f.mousemove(function(a){d&&i.borderScroll(j(a)),i.focus(i.coordAt(j(a)))}),f.mouseleave(function(){d&&i.borderScroll({x:a.width/2,y:a.height/2})}),f.click(function(a){i.coordAt(j(a))}),$(document).keydown(function(a){switch(a.keyCode){case b.left:i.rotate(-1);break;case b.up:i.zoom(1);break;case b.right:i.rotate(1);break;case b.down:i.zoom(-1)}return!1}),g.click(_.bind(e.start,e)),h.click(_.bind(e.stop,e)),e};return $(document).ready(function(){"use strict";var b=$("#window"),c=$('<canvas id="game-screen" width="'+b.width()+'" '+'height="'+b.height()+'"></canvas>');b.append(c),a.width=c.width(),a.height=c.height();var d=j({size:50}),e=l({draw:k(c[0].getContext("2d"))}),f=m({model:d,view:e});d.subscribe("board",_.bind(f.drawBoard,f));var g=n({$canvas:c,$startButton:$("#start"),$stopButton:$("#stop"),hex:f});g.start()}),{}}();