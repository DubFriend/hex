/*! hex 24-08-2013 */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof exports?module.exports=a:a(jQuery)}(function(a){function b(b){var e,f=b||window.event,g=[].slice.call(arguments,1),h=0,i=0,j=0,k=0,l=0;return b=a.event.fix(f),b.type="mousewheel",f.wheelDelta&&(h=f.wheelDelta),f.detail&&(h=-1*f.detail),f.deltaY&&(j=-1*f.deltaY,h=j),f.deltaX&&(i=f.deltaX,h=-1*i),void 0!==f.wheelDeltaY&&(j=f.wheelDeltaY),void 0!==f.wheelDeltaX&&(i=-1*f.wheelDeltaX),k=Math.abs(h),(!c||c>k)&&(c=k),l=Math.max(Math.abs(j),Math.abs(i)),(!d||d>l)&&(d=l),e=h>0?"floor":"ceil",h=Math[e](h/c),i=Math[e](i/d),j=Math[e](j/d),g.unshift(b,h,i,j),(a.event.dispatch||a.event.handle).apply(this,g)}var c,d,e=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],f="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"];if(a.event.fixHooks)for(var g=e.length;g;)a.event.fixHooks[e[--g]]=a.event.mouseHooks;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=f.length;a;)this.addEventListener(f[--a],b,!1);else this.onmousewheel=b},teardown:function(){if(this.removeEventListener)for(var a=f.length;a;)this.removeEventListener(f[--a],b,!1);else this.onmousewheel=null}},a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})});var createHex=function(){!function(){"use strict";var a={},b=Array.prototype,c=Object.prototype;Function.prototype;var d=(b.push,b.slice,b.concat,c.toString,c.hasOwnProperty),e=b.forEach,f=b.filter,g={};g.each=function(b,c,d){if(null!=b)if(e&&b.forEach===e)b.forEach(c,d);else if(b.length===+b.length){for(var f=0,h=b.length;h>f;f++)if(c.call(d,b[f],f,b)===a)return}else for(var i in b)if(g.has(b,i)&&c.call(d,b[i],i,b)===a)return},g.filter=function(a,b,c){var d=[];return null==a?d:f&&a.filter===f?a.filter(b,c):(g.each(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},g.isFunction=function(a){return"function"==typeof a},g.has=function(a,b){return d.call(a,b)};var h={};if("undefined"!=typeof exports)"undefined"!=typeof module&&module.exports&&(exports=module.exports=h),exports.jsMessage=h;else{if(void 0!==this.jsMessage)throw"jsMessage is allready defined";this.jsMessage=h}h.mixinPubSub=function(a){a=a||{};var b={},c=[];return a.subscribe=function(a,d){a?(b[a]=b[a]||[],b[a].push(d)):c.push(d)},a.unsubscribe=function(a,d){var e=function(c){return g.filter(b[c],function(b){return b!==a})};if(d){if(!b[d])throw"topic not found";b[d]=e(d)}else g.each(b,function(a,c){b[c]=e(c)}),c=g.filter(c,function(b){return b!==a})},a.publish=function(a,d){a?g.each(b[a],function(a){a(d)}):g.each(b,function(a){g.each(a,function(a){a&&a(d)})}),g.each(c,function(a){a(d)})},a.autoPublish=function(a,b){var c,d=this;return function(e){var f;return void 0===e?c:(c=e,f=b?b(e):e,d.publish(a,f),void 0)}},a},h.mixinEvents=function(a,b){var c={},d=b||{};return g.each(a,function(b,e){g.isFunction(b)&&(a[e]=function(){var f,h=b.apply(a,arguments);return c[e]&&(d[e]&&(f=d[e].apply(a,[h])),g.each(c[e],function(a){a(f)})),h})}),a.on=function(a,b){c[a]=c[a]||[],c[a].push(b)},a.off=function(a,b){c[a]=b?g.filter(c[a],function(a){return a!==b}):void 0},a}}.call(this);var a={width:null,height:null},b={left:37,up:38,right:39,down:40},c=function(a){return a.x+","+a.y},d=function(){"use strict";var a=function(a,b){return _.reduce(a,function(a,c){var d={};return _.each(c,function(c,e){d[e]=b(c,a[e])}),d})};return{add:function(){return a(arguments,function(a,b){return a+b})},dotProduct:function(){return a(arguments,function(a,b){return a*b})},negative:function(a){var b={};return _.each(a,function(a,c){b[c]=-a}),b},subtract:function(a,b){return this.add(a,this.negative(b))}}}(),e=function(a){return 0>a?-1:1},f=function(a){return[{x:a.x,y:a.y+1},{x:a.x,y:a.y-1},{x:a.x+1,y:a.y},{x:a.x+1,y:a.y-1},{x:a.x-1,y:a.y},{x:a.x-1,y:a.y+1}]},g=function(a,b){"use strict";b=b||{x:0,y:0};var c=[];return _.each(_.range(1+b.x-a,b.x+a),function(d){_.each(_.range(1+b.y-a,b.y+a),function(e){Math.abs(d-b.x+e-b.y)<a&&c.push({x:d,y:e})})}),c},h=function(a){"use strict";var b=jsMessage.mixinPubSub(),d=(a.size,null),e=function(){b.publish("board",d)};return b.getBoard=function(){return d},b.getTile=function(a){return d[c(a)]},b.setBoard=function(a){d=a,e()},b.setTile=function(){_.isArray(arguments[0])?b.setTile.apply(b,arguments[0]):(_.each(arguments,function(a){var c=b.getTile(a.coord);delete a.coord,_.each(a,function(a,b){c[b]=a})}),e())},b.focus=function(){var a={};return function(b){var f,g;_.isEqual(b,a)||(f=d[c(b)],g=d[c(a)],g&&(g.focus=!1),f&&(f.focus=!0),a=b,e())}}(),b},i=function(b){"use strict";var c={};return c.hexagon=function(){var a,c=[];return function(d){var e=d.center.x,f=d.center.y;d.radius!==a&&(a=d.radius,c=_.map(_.range(0,2*Math.PI,Math.PI/3),function(b){return{x:Math.cos(b)*a,y:Math.sin(b)*a/(1+(d.skewHeight||0)/2)}})),b.strokeStyle=d.color||"rgb(150, 150, 80)",b.font="normal 16px helvetica",b.lineWidth=d.lineWidth||1,b.beginPath(),b.moveTo(e+c[0].x,f+c[0].y),_.each(_.rest(c),function(a){b.lineTo(e+a.x,f+a.y)}),b.closePath(),b.stroke(),b.lineWidth=1,b.strokeText(d.coord.x+", "+d.coord.y,e,f)}}(),c.image=function(a){var c=[a.image];a.clip&&c.push(Math.floor(a.clip.coord.x),Math.floor(a.clip.coord.y),Math.floor(a.clip.width.x),Math.floor(a.clip.width.y)),c.push(a.coord.x,a.coord.y),a.width&&c.push(Math.floor(a.width.x),Math.floor(a.width.y)),b.drawImage.apply(b,c)},c.clear=function(c,d){c=c||{x:0,y:0},d=d||{x:a.width,y:a.height},b.clearRect(c.x,c.y,d.x,d.y)},c},j=function(){},k=function(a){var b=new j,c=a.image,d=a.frameSpeed,e=a.frames,f=0,g=0,h=Date.now(),i=!1;return b.getData=function(){if(!i)if(g>d)f+=1,g=0;else{var a=Date.now();g+=a-h,h=a}return{image:c,clip:e[f%e.length]}},b.pause=function(){i=!0},b.resume=function(){i=!1},b},l=function(b){"use strict";var e={},f=b.backgroundDraw,h=b.foregroundDraw,i=b.focusColor||"rgb(255, 92, 40)",k=b.focusWidth||7,l=b.skewHeight||0,m=null,n=null,o={x:a.width/2,y:a.height/2},p=function(a,b){return{x:1.5*a.x*m-b.x+o.x,y:2*a.y*n-b.y+o.y+a.x*n}},q=function(a){var b=Math.round(a.x/(1.5*m)),c=Math.round(-b/2+a.y/(2*n));return{x:b,y:c}},r=function(b){return b.x>=-m&&b.x<a.width+m&&b.y>=-m&&b.y<a.height+m},s=function(b){var c=Math.floor(_.max([a.width,a.height])/(1.5*m)/2+6);return g(c,q(b))},t=function(a){m=a,n=a*Math.sqrt(3)/(2+l)};return e.pixelToCoord=function(a){return t(a.radius),q(d.add(a.center,d.subtract(a.pixel,o)))},e.drawForeground=function(a){t(a.radius),_.each(s(a.center),function(b){var d=p(b,a.center),e=a.board[c(b)],f={x:d.x-m,y:d.y-n},g={x:2*m,y:2*n};if(e&&r(d)&&e.foreground&&e.foreground instanceof j){var i=e.foreground.getData();h.image({image:i.image,clip:i.clip,coord:f,width:g})}})},e.drawHexagonalGrid=function(a){t(a.radius),_.each(s(a.center),function(b){var d=p(b,a.center),e=a.board[c(b)],g={x:d.x-m,y:d.y-n},o={x:2*m,y:2*n};if(e&&r(d)){if(f.image({image:e.background.image,clip:e.background.clip,coord:g,width:o}),e.foreground&&e.foreground instanceof j){var q=e.foreground.getData();h.image({image:q.image,clip:q.clip,coord:g,width:o})}e.focus&&f.hexagon({center:d,radius:m,coord:b,color:i,lineWidth:k,skewHeight:l})}})},e.clearBackground=_.bind(f.clear,f),e.clearForeground=_.bind(h.clear,h),e},m=function(b){"use strict";var c={},f=b.model,g=b.view,h={x:1,y:0},i={x:0,y:0},j=b.radius||60,k={min:b.minZoom||25,max:b.maxZoom||150,diff:0},l=function(){var a=j+k.diff>=k.min&&j+k.diff<=k.max?j+k.diff:j;h.x*=a/j,h.y*=a/j,j=a};return c.drawBoard=function(a){g.clearBackground(),g.clearForeground(),g.drawHexagonalGrid({board:a,center:h,radius:j})},c.drawForeground=function(a){g.clearForeground(),g.drawForeground({board:a,center:h,radius:j})},c.tick=function(){var a,b={x:0,y:0};return function(){l(),0!==i.x||0!==i.y||a!==j?(h=d.add(h,i),c.drawBoard(f.getBoard()),b.x=h.x,b.y=h.y,a=j):c.drawForeground(f.getBoard())}}(),c.focus=function(a){f.focus(a)},c.zoom=function(a){k.diff=j+a>=k.min&&j+a<=k.max?a:0},c.coordAt=function(a){return g.pixelToCoord({center:h,radius:j,pixel:a})},c.borderScroll=function(){var b=function(b){var c={x:a.width/2.8,y:a.height/2.8};return Math.abs(b.x)>c.x?{x:e(b.x)*(Math.abs(b.x)-c.x)/7,y:b.y/50}:Math.abs(b.y)>c.y?{y:e(b.y)*(Math.abs(b.y)-c.y)/7,x:b.x/50}:{x:0,y:0}};return function(c){i=b({x:c.x-a.width/2,y:c.y-a.height/2})}}(),c},n=function(a){"use strict";a=a||{};var b={},c=a.$canvas,d=a.hex,e=function(a){var b,c,d;return a||(a=window.event),a.target?b=a.target:a.srcElement&&(b=a.srcElement),3==b.nodeType&&(b=b.parentNode),c=a.pageX-$(b).offset().left,d=a.pageY-$(b).offset().top,{x:c,y:d}},f=function(b,c){var d=a.key[c.keyCode];return d&&d[b]?d[b]():console.log("unrecognized key ("+b+")"),!1};return $(document).keydown(_.partial(f,"down")),$(document).keyup(_.partial(f,"up")),c.mousemove(_.compose(a.mouseMove,e)),c.mouseleave(_.compose(a.mouseLeave,e)),c.click(_.compose(a.click,e)),c.mousewheel(function(b,c,d,e){b.preventDefault(),a.mouseWheel(d,e)}),b.start=function(){d.tick(),requestAnimationFrame(_.bind(b.start,b))},b},o=function(d){"use strict";d=d||{};var e={},j=d.$gameWindow,o=function(a){return $('<canvas class="'+a+'" '+'width="'+j.width()+'" '+'height="'+j.height()+'"></canvas>')},p=o("background"),q=o("foreground");j.append(p),j.append(q),a.width=q.width(),a.height=q.height();var r=h({size:d.size}),s=l({backgroundDraw:i(p[0].getContext("2d")),foregroundDraw:i(q[0].getContext("2d")),focusColor:d.focusColor,focusWidth:d.focusWidth,skewHeight:d.skewHeight}),t=m({model:r,view:s,minZoom:d.minZoom,maxZoom:d.maxZoom,radius:d.radius});e.zoom=_.bind(t.zoom,t),e.zoomIn=_.partial(e.zoom,1),e.zoomOut=_.partial(e.zoom,-1),e.zoomStop=_.partial(e.zoom,0),e.borderScroll=_.bind(t.borderScroll,t),e.focus=_.bind(t.focus,t),e.coordAt=_.bind(t.coordAt,t),e.stopScroll=_.partial(t.borderScroll,{x:a.width/2,y:a.height/2}),e.setTile=_.bind(r.setTile,r),e.setBoard=_.bind(r.setBoard,r),e.getTile=_.bind(r.getTile,r),e.getBoard=_.bind(r.getBoard,r),e.hexagonOfCoordinates=g,e.stringKey=c,e.neighborCoordinates=f,e.createSprite=k;var u=n({$canvas:q,hex:t,mouseMove:_.bind(d.mouseMove,e),mouseLeave:_.bind(d.mouseLeave,e),click:_.bind(d.click,e),mouseWheel:_.bind(d.mouseWheel,e),key:d.key.call(e,b)});return e.start=_.bind(u.start,u),r.subscribe("board",_.bind(t.drawBoard,t)),e};return o}();$(document).ready(function(){"use strict";var a=createHex({$gameWindow:$("#window"),size:50,skewHeight:1,minZoom:40,maxZoom:150,radius:70,focusColor:"orange",focusWidth:9,mouseMove:function(a){this.borderScroll(a),this.focus(this.coordAt(a))},mouseLeave:function(){this.stopScroll()},mouseWheel:function(a,b){this.zoom(7*b),setTimeout(_.bind(this.zoomStop,this),60)},click:function(a){console.log(this.coordAt(a))},key:function(a){var b={};return b[a.up]={down:this.zoomIn,up:this.zoomStop},b[a.down]={down:this.zoomOut,up:this.zoomStop},b}}),b=new Image,c=new Image,d=new Image;b.src="hexagon_light.png",c.src="hexagon_dark.png",d.src="smurf_sprite.png";var e={coord:{x:4,y:0},width:{x:442,y:388}};a.setBoard(function(){var d={};return _.each(a.hexagonOfCoordinates(50),function(f){d[a.stringKey(f)]={background:{image:_.random(1)?b:c,clip:e}}}),d}());var f=a.createSprite({image:d,frameSpeed:50,frames:_.map(_.range(16),function(a){return{coord:{x:128*(a%4),y:128*Math.floor(a/4)},width:{x:128,y:128}}})});a.setTile(_.map(_.range(50),function(){return{coord:{x:_.random(-15,15),y:_.random(-15,15)},foreground:f}})),setInterval(function(){var d=0;return function(){a.setTile(_.map(a.neighborCoordinates({x:0,y:0}),function(a){return{coord:a,background:{image:0===d%2?b:c,clip:e}}})),a.setTile({coord:{x:0,y:0},background:{image:1===d%2?b:c,clip:e}}),d+=1}}(),500),a.start()});